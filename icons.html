<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Moonlight Icons</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
  <style>
    :root{
      --bg:#0f1115; --panel:#141925; --card:#141b29; --ring:#25304a;
      --text:#edf2fb; --muted:#a7b0c1; --accent:#28c8ff; --accent-2:#8bdfff;
      --chip:#0f2230; --chip-ring:#1e3b4b; --shadow:0 14px 40px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}

    /* Full-page background + base typography */
    body{
      margin:0; min-height:100vh; display:flex; flex-direction:column;
      background:url("imgs/Icon.png") no-repeat center center fixed;
      background-size:cover; position:relative; color:var(--text);
      font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial;
    }
    /* Dark overlay for readability */
    body::before{content:""; position:fixed; inset:0; background:rgba(15,17,21,.6); z-index:-1;}

    .wrap{max-width:1200px;margin:28px auto;padding:0 14px}

    /* Header */
    header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
    header img{width:38px;height:38px;border-radius:10px;box-shadow:var(--shadow)}
    h1{margin:0;font-size:24px;letter-spacing:.2px}
    .badge{margin-left:8px;background:var(--chip);border:1px solid var(--chip-ring);color:var(--accent-2);
      padding:2px 8px;border-radius:999px;font-size:12px}

    /* Panel & controls */
    .panel{background:var(--panel);border:1px solid var(--ring);border-radius:16px;padding:14px;box-shadow:var(--shadow)}
    .controls{
      position:sticky;top:0;z-index:5;background:var(--panel);
      display:grid;grid-template-columns:1fr 96px 230px;gap:8px;align-items:center;
      padding-bottom:8px
    }
    .search{display:flex;align-items:center;gap:10px;background:var(--card);border:1px solid var(--ring);
      border-radius:12px;padding:10px 12px}
    .search input{flex:1;background:transparent;border:0;color:var(--text);font-size:15px;outline:none}
    .btn{appearance:none;border:1px solid var(--ring);background:var(--card);color:var(--text);
      padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:600}
    .btn:hover{border-color:#3a4663}
    .btn.accent{background:linear-gradient(180deg,#2ad1ff,#1593ff);border-color:#0f84e8}
    .small{padding:8px 10px;border-radius:10px;font-weight:700}
    .hint{color:var(--muted);font-size:13px;margin:8px 2px 0}

    /* Grid & card */
    .results{margin-top:12px;display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px}
    .card{
      background:var(--card); border:1px solid var(--ring); border-radius:16px; padding:14px;
      display:flex; flex-direction:column; gap:12px; min-height:220px;
      box-shadow:0 6px 16px rgba(0,0,0,.25); transition:transform .2s, box-shadow .2s;
    }
    .card:hover{ transform:translateY(-3px); box-shadow:0 10px 22px rgba(0,0,0,.35); }

    .thumb{width:100%; aspect-ratio:16/9; background:#0e131c; border:1px solid var(--ring); border-radius:10px;
      display:flex; align-items:center; justify-content:center; overflow:hidden}
    .thumb img{width:100%; height:100%; object-fit:contain}

    .meta{display:flex;justify-content:space-between;align-items:flex-start;gap:10px;min-height:42px}
    .title{font-weight:700;font-size:14px;line-height:1.2;
      display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:2;overflow:hidden;text-overflow:ellipsis;}
    .chip{font:700 11px ui-monospace,Menlo,Consolas,monospace;color:var(--accent-2);
      background:var(--chip);border:1px solid var(--chip-ring);padding:4px 8px;border-radius:999px;white-space:nowrap}

    .actions{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-top:auto}
    .actions .btn{display:flex;align-items:center;justify-content:center;gap:6px}
    [data-action="market"]{cursor:pointer;user-select:none}

    .loading{padding:16px;text-align:center;color:var(--muted)}
    .error{color:#ffb3ba;background:#2a1010;border:1px solid #552222;padding:10px 12px;border-radius:10px;margin-top:12px}

    /* Pager */
    .pager{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-top:14px}
    .pager .left,.pager .right{display:flex;gap:6px}
    .pager .page-btn{min-width:38px;padding:8px 10px;border-radius:10px;border:1px solid var(--ring);background:var(--card);color:var(--text);cursor:pointer}
    .pager .page-btn[disabled]{opacity:.5;cursor:not-allowed}
    .pager .page-num{padding:8px 12px;border-radius:10px;border:1px solid var(--ring);background:var(--card);color:var(--text);width:72px;text-align:center}
    .pager .summary{color:var(--muted);font-size:13px}

    /* Mobile */
    @media (max-width:900px){
      .controls{grid-template-columns:1fr 84px 1fr}
      .results{grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px}
      .thumb{aspect-ratio:4/3}
      .actions{grid-template-columns:1fr 1fr}
      .actions .btn:last-child{grid-column:1 / -1}
    }
    @media (max-width:600px){
      .results{grid-template-columns:repeat(auto-fill,minmax(150px,1fr))}
      .title{-webkit-line-clamp:1}
    }
    @media (max-width:520px){
      h1{font-size:20px}
      .btn.accent{font-size:13px}
      .pager{flex-direction:column;gap:8px}
    }

    /* ===== Corner Home Button ===== */
    .corner-home{
      position:fixed;top:16px;left:16px;z-index:1000; display:inline-flex;align-items:center;gap:8px;
      padding:10px 12px;border-radius:999px; background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));
      border:1px solid var(--ring); color:var(--text); text-decoration:none; font-weight:700;
      box-shadow:0 8px 24px rgba(0,0,0,.35); backdrop-filter:blur(8px);
      transform:translateY(-8px); opacity:0; animation:homeIn .45s cubic-bezier(.2,.8,.2,1) .2s forwards;
      transition:transform .2s ease, box-shadow .2s ease, border-color .2s ease, background .2s ease;
    }
    .corner-home:hover{transform:translateY(-2px); border-color:var(--accent);
      background:linear-gradient(180deg,rgba(40,200,255,.16),rgba(40,200,255,.06));
      box-shadow:0 12px 28px rgba(0,0,0,.45),0 0 0 2px rgba(40,200,255,.15) inset;}
    .corner-home i{font-size:14px}
    .corner-home:active{transform:translateY(0)}
    .corner-home:focus-visible{outline:none; box-shadow:0 0 0 3px rgba(40,200,255,.5)}
    @media (max-width:640px){.corner-home{padding:10px}.corner-home .label{display:none}}
    @keyframes homeIn{from{transform:translateY(-8px);opacity:0} to{transform:translateY(0);opacity:1}}

    /* ---------- Logo animations ---------- */
    .logo-wrap{position:relative;display:inline-flex;align-items:center;justify-content:center;width:40px;height:40px}
    .logo-wrap::after{content:"";position:absolute;inset:-6px;border-radius:12px;
      background:radial-gradient(ellipse at center,rgba(40,200,255,.35) 0%,rgba(40,200,255,.12) 45%,rgba(40,200,255,0) 70%);
      filter:blur(6px);opacity:0;animation:pulse 2.8s ease-out infinite 1s;pointer-events:none}
    .site-header .logo{width:38px;height:38px;border-radius:10px;display:block;opacity:0;transform:translateY(6px) scale(.88);
      animation:logo-in .6s cubic-bezier(.2,.9,.25,1.2) .05s forwards, float 7s ease-in-out 1s infinite;
      filter:drop-shadow(0 2px 10px rgba(0,0,0,.25)) drop-shadow(0 0 6px rgba(40,200,255,.18));
      transition:transform .2s ease, filter .2s ease}
    .site-header .logo:hover{transform:translateY(-1px) scale(1.06);
      filter:drop-shadow(0 4px 14px rgba(0,0,0,.3)) drop-shadow(0 0 10px rgba(40,200,255,.28))}
    @keyframes logo-in{to{opacity:1;transform:translateY(0) scale(1)}}
    @keyframes float{0%,100%{transform:translateY(0)} 50%{transform:translateY(-3px)}}
    @keyframes pulse{0%{transform:scale(.92);opacity:.55} 60%{transform:scale(1.15);opacity:.18} 100%{transform:scale(1.25);opacity:0}}

    /* Toast */
    .ml-toast{
      position:fixed;left:50%;bottom:28px;transform:translateX(-50%) translateY(20px);
      padding:10px 14px;background:rgba(20,24,32,.9);color:#e9eefc;border:1px solid rgba(255,255,255,.08);
      border-radius:10px;font:600 14px/1.1 ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
      box-shadow:0 10px 30px rgba(0,0,0,.25);opacity:0;pointer-events:none;transition:opacity .18s, transform .18s;z-index:9999;white-space:nowrap}
    .ml-toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

    /* ---------- Right Sidebar: Live Status ---------- */
    .embed-panel{position:fixed;top:96px;right:24px;width:420px;max-width:35vw;
      background:rgba(20,24,32,.78);border:1px solid var(--ring);border-radius:14px;
      box-shadow:var(--shadow);backdrop-filter:blur(10px);padding:12px;z-index:50}
    .tabbar{display:flex;gap:6px;margin-bottom:10px}
    .tab-btn{flex:1;cursor:pointer;border:1px solid var(--ring);background:var(--card);color:var(--text);
      padding:8px 10px;border-radius:10px;font-weight:700;text-align:center}
    .tab-btn.active{border-color:#5da7ff;background:linear-gradient(180deg,#2ad1ff1a,#1593ff1a)}
    .embed-card{background:#111723;border:1px solid #2a3550;border-radius:12px;padding:12px;display:flex;gap:10px}
    .embed-accent{width:4px;border-radius:6px;background:linear-gradient(180deg,#5865F2,#15a7ff)}
    .embed-body{flex:1}
    .embed-title{font-weight:800;font-size:15px;margin-bottom:6px}
    .embed-desc{color:#c7d0e3;font-size:14px;line-height:1.35}
    .stat-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px}
    .stat{background:#0e1624;border:1px solid #24314b;border-radius:8px;padding:8px}
    .stat .k{font-size:11px;color:#9fb6ff;font-weight:700;margin-bottom:2px}
    .stat .v{font-size:16px;font-weight:800}
    .avatars{display:flex;flex-wrap:wrap;gap:6px;margin-top:10px}
    .avatars img{width:24px;height:24px;border-radius:50%;border:1px solid #24314b}
    .embed-actions{display:flex;gap:8px;margin-top:10px}
    .embed-actions .btn{flex:1}
    .section{display:none}
    .section.active{display:block}
    @media (max-width:1400px){.embed-panel{display:none}}

    /* Server banner/logo */
.server-banner {
  width: 100%;
  margin-bottom: 12px;
  border-radius: 10px;
  overflow: hidden;
  border: 1px solid var(--ring);
  box-shadow: 0 6px 20px rgba(0,0,0,0.35);
}
.server-banner img {
  width: 100%;
  height: auto;
  display: block;
  object-fit: cover;
}


  </style>
</head>
<body>

  <!-- Corner Home Button -->
  <a href="/" class="corner-home" aria-label="Go to Home">
    <i class="fa-solid fa-house"></i><span class="label">Home</span>
  </a>

  <div class="wrap">
    <header class="site-header">
      <span class="logo-wrap">
        <img class="logo" src="imgs/PF-Sketch.png" alt="logo"
             onerror="this.src='https://avatars.githubusercontent.com/u/9919?s=80&v=4'">
      </span>
      <h1>Moonlight Icons <span class="badge" id="count-badge">loading…</span></h1>
    </header>

    <div class="panel">
      <div class="controls">
        <div class="search">
          <i class="fa-solid fa-magnifying-glass" aria-hidden="true"></i>
          <input id="q" placeholder="Search by ID, Name, or paste a PNG URL…">
        </div>
        <button class="btn small" id="clear">Clear</button>
        <button class="btn accent small" id="copyAll">Copy filtered (Wording)</button>
      </div>

      <div class="hint">Uses <code>items.json</code> (same folder) to map ItemID → Name and local images at <code>Icons/{ID}.png</code>.</div>

      <div id="status" class="loading">Loading local icons…</div>
      <div id="error" class="error" style="display:none"></div>

      <div id="results" class="results" style="display:none"></div>

      <div id="pager" class="pager" style="display:none">
        <div class="left">
          <button class="page-btn" id="firstPage" title="First">&laquo;</button>
          <button class="page-btn" id="prevPage" title="Prev">&lsaquo;</button>
        </div>
        <div class="summary">
          <span id="rangeText">0–0</span> of <span id="totalText">0</span> • Page
          <input id="pageInput" class="page-num" type="number" min="1" value="1">
          / <span id="pageCount">1</span>
        </div>
        <div class="right">
          <button class="page-btn" id="nextPage" title="Next">&rsaquo;</button>
          <button class="page-btn" id="lastPage" title="Last">&raquo;</button>
        </div>
      </div>
    </div>

    <!-- Right-side Live Status -->
    <aside class="embed-panel" id="statusPanel">
      <div class="tabbar">
        <button class="tab-btn active" data-tab="discord">Discord</button>
        <button class="tab-btn" data-tab="server">Server</button>
      </div>

      <!-- Discord section -->
      <section class="section active" id="sec-discord">
        <div class="embed-card">
          <div class="embed-accent"></div>
          <div class="embed-body">
            <div class="embed-title" id="dc-name">Discord — Loading…</div>
            <div class="embed-desc" id="dc-desc">Fetching online count and members…</div>

            <div class="stat-grid">
              <div class="stat">
                <div class="k">Online now</div>
                <div class="v" id="dc-online">—</div>
              </div>
              <div class="stat">
                <div class="k">Owner</div>
                <div class="v" id="dc-invite">—</div>
              </div>
            </div>

            <div class="avatars" id="dc-avatars"></div>

            <div class="embed-actions">
              <a class="btn small" id="dc-open" href="#" target="_blank" rel="noreferrer">Join Server</a>
              <button class="btn small" id="dc-copy">Copy Invite</button>
            </div>
          </div>
        </div>
      </section>

      <!-- Game server section (optional; uses your own status JSON) -->
<section class="section" id="sec-server">
  <div class="embed-card">
    <div class="embed-accent"></div>
    <div class="embed-body">

      <!-- Banner/logo -->
      <div class="server-banner">
        <img src="imgs\logo-menu.png" alt="Moonlight Logo">
      </div>

      <div class="embed-title" id="sv-name">Server — Loading…</div>
      <div class="embed-desc" id="sv-desc">Live player count, map, queue.</div>

      <div class="stat-grid">
        <div class="stat">
          <div class="k">Players</div>
          <div class="v" id="sv-players">—</div>
        </div>
        <div class="stat">
          <div class="k">Map</div>
          <div class="v" id="sv-map">—</div>
        </div>
      </div>

      <div class="embed-actions">
        <button class="btn small" id="sv-refresh">Refresh</button>
        <button class="btn small" id="sv-copy">Copy IP</button>
      </div>
    </div>
  </div>
</section>

    </aside>
  </div>

  <script>
    /* ===== Utilities ===== */
    const $ = (id)=>document.getElementById(id);
    const resultsEl=$('results'), statusEl=$('status'), errorEl=$('error'),
          qEl=$('q'), countBadge=$('count-badge');
    const pagerEl=$('pager'), rangeText=$('rangeText'), totalText=$('totalText'),
          pageInput=$('pageInput'), pageCountEl=$('pageCount'),
          firstBtn=$('firstPage'), prevBtn=$('prevPage'), nextBtn=$('nextPage'), lastBtn=$('lastPage');

    let ITEMS=[], FILTERED=[], PAGE_SIZE=50, currentPage=1, pageCount=1;

    const debounce=(fn,ms=150)=>{ let t; return(...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; };
    const escapeHTML=(s)=>String(s).replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m]));

    /* ===== Data load & render ===== */
    function getDisplayName(val){
      try{
        if (typeof val === "string"){
          let s = val.trim();
          if ((s.startsWith("{") && s.endsWith("}")) || (s.startsWith("[") && s.endsWith("]"))){
            const obj = JSON.parse(s); return getDisplayName(obj) || s;
          }
          const m = s.match(/"?\bItemName\b"?\s*:\s*"?([^"]+)"?/i);
          if (m) return m[1].trim();
          return s.replace(/^"+|"+$/g,'').trim();
        }
        if (val && typeof val === "object"){
          const keys = ["ItemName","itemName","Name","name","title","Title","displayName","DisplayName","item"];
          for (const k of keys){ if (val[k]) return getDisplayName(val[k]); }
          for (const k in val){ if (typeof val[k]==="string") return val[k].trim(); }
        }
      }catch(_){}
      return "";
    }

    function parseQuery(raw){
      let q=(raw||"").trim();
      if(/\.png(\?|$)/i.test(q)){ const m=q.match(/(\d+)(?:\.png)?(?:\?.*)?$/i); if(m) return m[1]; }
      const n=q.match(/\b(\d{1,8})\b/); if(n) return n[1];
      return q;
    }

    async function loadIndex(){
      try{
        let names={}; try{ names = await (await fetch("items.json?t="+Date.now())).json(); } catch{ names={}; }
        const idsFromNames = Object.keys(names).map(k=>parseInt(k,10)).filter(n=>!isNaN(n)).sort((a,b)=>a-b);
        const ids = idsFromNames.length ? idsFromNames : Array.from({length:1200},(_,i)=>i+1);

        ITEMS = ids.map(id=>{
          const sid = String(id);
          const disp = getDisplayName(names[sid]) || sid;
          return { id: sid, name: disp, url: `Icons/${sid}.png` };
        });

        FILTERED = ITEMS.slice();
        countBadge.textContent = `${ITEMS.length} items (local)`;
        statusEl.style.display="none";
        resultsEl.style.display="grid";
        pagerEl.style.display="flex";
        computeAndRenderPage(1);

        if (typeof updateDiscordEmbed === 'function') updateDiscordEmbed(); // old embed
if (typeof fetchDiscord === 'function') fetchDiscord();             // live-status embed

      }catch(e){
        statusEl.style.display="none";
        errorEl.style.display="block";
        errorEl.textContent="Failed to load: "+e.message;
      }
    }

    function computeAndRenderPage(page){
      currentPage = Math.max(1, Math.min(page, Math.max(1, Math.ceil(FILTERED.length / PAGE_SIZE))));
      pageCount = Math.max(1, Math.ceil(FILTERED.length / PAGE_SIZE));
      const start = (currentPage-1) * PAGE_SIZE;
      const end   = Math.min(start + PAGE_SIZE, FILTERED.length);
      render(FILTERED.slice(start, end));

      rangeText.textContent = FILTERED.length ? `${start+1}–${end}` : "0–0";
      totalText.textContent = FILTERED.length;
      pageInput.value = String(currentPage);
      pageInput.max   = String(pageCount);
      pageCountEl.textContent = String(pageCount);

      firstBtn.disabled = currentPage<=1;
      prevBtn.disabled  = currentPage<=1;
      nextBtn.disabled  = currentPage>=pageCount;
      lastBtn.disabled  = currentPage>=pageCount;
    }

    function render(list){
      resultsEl.innerHTML = list.map(({id,name,url})=>{
        const clean = name || id;
        return `
          <div class="card" data-item-id="${id}">
            <div class="thumb">
              <img src="${url}" alt="${escapeHTML(clean)}" loading="lazy"
                   onerror="this.closest('.card')?.remove()">
            </div>
            <div class="meta">
              <div class="title" title="${escapeHTML(clean)}">${escapeHTML(clean)}</div>
              <div class="chip">ID ${escapeHTML(id)}</div>
            </div>
            <div class="actions">
              <button class="btn small" onclick="copy('${url}')" title="Copy image URL">
                <i class="fa-regular fa-copy"></i><span>URL</span>
              </button>

              <button class="btn small" data-action="market" title="Copy /market add {id}">
                <i class="fa-solid fa-basket-shopping"></i>
                <span>/market add</span>
              </button>

              <a class="btn small" href="${url}" target="_blank" rel="noreferrer" title="Open image">
                <i class="fa-solid fa-up-right-from-square"></i><span>Open</span>
              </a>
            </div>
          </div>`;
      }).join("");
    }

    function doSearch(){
      const q=parseQuery(qEl.value).toLowerCase();
      if(!q){ FILTERED = ITEMS.slice(); computeAndRenderPage(1); return; }
      FILTERED = ITEMS.filter(x => x.id.includes(q) || (x.name||"").toLowerCase().includes(q));
      computeAndRenderPage(1);
    }
    const doSearchDebounced = debounce(doSearch, 120);

    async function copy(text){
      try{ await navigator.clipboard.writeText(text); toast("Copied!"); }
      catch{ toast("Could not copy"); }
    }
    let toastEl;
    function toast(msg){
      if(!toastEl){ toastEl=document.createElement('div'); toastEl.className='ml-toast'; document.body.appendChild(toastEl); }
      toastEl.textContent=msg; toastEl.getBoundingClientRect(); toastEl.classList.add('show');
      setTimeout(()=>toastEl.classList.remove('show'), 1200);
    }

    function bindPager(){
      firstBtn.addEventListener('click', ()=>computeAndRenderPage(1));
      prevBtn.addEventListener('click',  ()=>computeAndRenderPage(currentPage-1));
      nextBtn.addEventListener('click',  ()=>computeAndRenderPage(currentPage+1));
      lastBtn.addEventListener('click',  ()=>computeAndRenderPage(pageCount));
      pageInput.addEventListener('change', ()=>{
        const n = parseInt(pageInput.value,10);
        if(!isNaN(n)) computeAndRenderPage(n);
        else pageInput.value = String(currentPage);
      });
    }

    /* ===== Right-side Status (Discord + Server) ===== */
    const DISCORD_GUILD_ID = '1124512596687597678'; // <--- set this
    const SERVER_STATUS_URL = 'https://unturned-servers.net/api/?object=servers&element=detail&key=CimDF1IOUBr1x5EdZzZcXpFu2GSaEtWcJ1Q';


    // Tabs
    (function tabs(){
      const panel = document.getElementById('statusPanel');
      if(!panel) return;
      panel.addEventListener('click', (e)=>{
        const btn = e.target.closest('.tab-btn'); if(!btn) return;
        panel.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        const tab = btn.dataset.tab;
        panel.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
        panel.querySelector('#sec-'+tab).classList.add('active');
      });
    })();

    // Discord widget fetch (requires "Enable Server Widget" in Discord settings)
    async function fetchDiscord(){
      if(!DISCORD_GUILD_ID) return;
      try{
        const res = await fetch(`https://discord.com/api/guilds/${DISCORD_GUILD_ID}/widget.json`, { cache: 'no-store' });
        if(!res.ok) throw new Error('Widget disabled or wrong guild ID');
        const data = await res.json();

        $('dc-name').textContent = data.name || 'Discord';
        $('dc-online').textContent = (data.presence_count ?? data.members?.length ?? 0).toLocaleString();
        $('dc-invite').textContent = data.instant_invite ? 'Available' : 'Mochi & Bush';
        $('dc-desc').textContent = 'Live members online (auto-updates).';

        const av = $('dc-avatars'); av.innerHTML = '';
        (data.members || []).slice(0,12).forEach(m=>{
          const img = document.createElement('img'); img.src = m.avatar_url; img.alt = m.username; av.appendChild(img);
        });

        const invite = data.instant_invite || '#';
        $('dc-open').href = invite;
        $('dc-copy').onclick = async ()=>{ try{ await navigator.clipboard.writeText(invite); toast('Invite copied!'); } catch{ toast('Could not copy'); } };
      }catch{
        $('dc-name').textContent = 'Discord';
        $('dc-desc').textContent = 'Widget disabled or wrong Guild ID. Enable it in Server Settings → Widget.';
        $('dc-online').textContent = '—'; $('dc-invite').textContent = '—';
      }
    }

    // Optional: Game server status
    async function fetchServerStatus(manual=false){
      if(!SERVER_STATUS_URL){ if(manual) toast('Set SERVER_STATUS_URL first'); return; }
      try{
        const res = await fetch(SERVER_STATUS_URL, { cache: 'no-store' });
        const s = await res.json();
        $('sv-name').textContent = s.name || 'Game Server';
        $('sv-players').textContent = (s.players ?? 0) + (s.maxPlayers ? ` / ${s.maxPlayers}` : '');
        $('sv-map').textContent = s.map || '—';
        const ip = [s.ip, s.port].filter(Boolean).join(':');
        $('sv-copy').onclick = async ()=>{ try{ await navigator.clipboard.writeText(ip); toast('IP copied!'); } catch{ toast('Could not copy'); } };
      }catch{
        $('sv-name').textContent = 'Server';
        $('sv-players').textContent = '—';
        $('sv-map').textContent = '—';
        if(manual) toast('Server status unavailable');
      }
    }
    $('sv-refresh')?.addEventListener('click', ()=>fetchServerStatus(true));

    // Middle button: copy /market add {id}
    (()=>{
      document.addEventListener('click', async (ev) => {
        const trigger = ev.target.closest('[data-action="market"]');
        if (!trigger) return;
        const card = trigger.closest('[data-item-id]');
        const itemId = card?.dataset?.itemId?.trim();
        if (!itemId){ showToast('Missing item ID'); return; }
        const cmd = `/market add ${itemId}`;
        try { await navigator.clipboard.writeText(cmd); showToast(`Copied “${cmd}”`); }
        catch {
          try {
            const ta = document.createElement('textarea'); ta.value = cmd; ta.setAttribute('readonly','');
            ta.style.position='fixed'; ta.style.opacity='0'; document.body.appendChild(ta);
            ta.select(); document.execCommand('copy'); ta.remove(); showToast(`Copied “${cmd}”`);
          } catch { showToast('Copy failed'); }
        }
      });
      let toastTimer;
      function showToast(message='Copied'){
        clearTimeout(toastTimer);
        let t = document.querySelector('.ml-toast');
        if (!t){ t = document.createElement('div'); t.className='ml-toast'; document.body.appendChild(t); }
        t.textContent = message; t.getBoundingClientRect(); t.classList.add('show');
        toastTimer = setTimeout(()=>t.classList.remove('show'), 1600);
      }
      window.showToast = showToast; // expose for reuse
    })();

    /* ===== Wire up events and load ===== */
    qEl.addEventListener('input', doSearchDebounced);
    qEl.addEventListener('paste', ()=>setTimeout(()=>{ qEl.value=parseQuery(qEl.value); doSearch(); },0));
    $('clear').addEventListener('click', ()=>{ qEl.value=''; doSearch(); qEl.focus(); });
    $('copyAll').addEventListener('click', ()=>{
      const start=(currentPage-1)*PAGE_SIZE, end=Math.min(start+PAGE_SIZE, FILTERED.length);
      const pageItems = FILTERED.slice(start, end);
      if(!pageItems.length){ toast("No results to copy"); return; }
      const lines = pageItems.map(x=>`${x.name || x.id} (ID: ${x.id})`).join("\n");
      copy(lines);
    });

    bindPager();
    loadIndex();

    // Live status loops
    fetchDiscord(); setInterval(fetchDiscord, 30_000);
    fetchServerStatus(); if(SERVER_STATUS_URL) setInterval(fetchServerStatus, 15_000);
  </script>
</body>
</html>
